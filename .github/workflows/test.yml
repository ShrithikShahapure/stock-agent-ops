name: Test (Manual Dispatch)

on:
  workflow_dispatch:
    inputs:
      ref:
        description: 'Branch, tag, or SHA to test'
        type: string
        default: main
      go:
        description: 'Go unit tests (internal/...)'
        type: boolean
        default: true
      frontend:
        description: 'Frontend unit tests (Vitest)'
        type: boolean
        default: true
      python_unit:
        description: 'Python unit tests (tests/unit/)'
        type: boolean
        default: true
      python_integration:
        description: 'Python integration tests (tests/integration/)'
        type: boolean
        default: true

permissions:
  contents: read

jobs:
  test-go:
    if: inputs.go
    uses: ShrithikShahapure/reuseable-actions/.github/workflows/test-go.yml@main
    with:
      test_path: './internal/...'
      race: true
      coverage: true
      ref: ${{ inputs.ref }}

  test-frontend:
    if: inputs.frontend
    uses: ShrithikShahapure/reuseable-actions/.github/workflows/test-node.yml@main
    with:
      working_directory: 'frontend'
      test_command: 'npm test -- --run --reporter=verbose --coverage'
      ref: ${{ inputs.ref }}

  test-python-unit:
    if: inputs.python_unit
    uses: ShrithikShahapure/reuseable-actions/.github/workflows/test-python.yml@main
    with:
      test_path: 'tests/unit/'
      package_manager: 'uv'
      cpu_only_torch: true
      artifact_name: 'pytest-unit-results'
      ref: ${{ inputs.ref }}

  test-python-integration:
    if: inputs.python_integration
    uses: ShrithikShahapure/reuseable-actions/.github/workflows/test-python.yml@main
    with:
      test_path: 'tests/integration/'
      package_manager: 'uv'
      cpu_only_torch: true
      artifact_name: 'pytest-integration-results'
      ref: ${{ inputs.ref }}

  summary:
    name: Summary
    runs-on: ubuntu-latest
    if: always()
    needs: [test-go, test-frontend, test-python-unit, test-python-integration]
    steps:
      - name: Report results
        run: |
          passed=0
          failed=0
          skipped=0

          check() {
            local name="$1" result="$2"
            case "$result" in
              success)  echo "  PASS  $name"; ((passed++))  ;;
              skipped)  echo "  SKIP  $name (not selected)"; ((skipped++)) ;;
              *)        echo "  FAIL  $name ($result)"; ((failed++)) ;;
            esac
          }

          echo ""
          echo "Test dispatch results (ref: ${{ inputs.ref }})"
          echo "────────────────────────────────────────────"
          check "Go unit tests"              "${{ needs.test-go.result }}"
          check "Frontend unit tests"        "${{ needs.test-frontend.result }}"
          check "Python unit tests"          "${{ needs.test-python-unit.result }}"
          check "Python integration tests"   "${{ needs.test-python-integration.result }}"
          echo "────────────────────────────────────────────"
          echo "  Passed:  $passed"
          echo "  Skipped: $skipped"
          echo "  Failed:  $failed"
          echo ""

          if [ "$failed" -gt 0 ]; then
            echo "One or more test suites failed."
            exit 1
          fi
