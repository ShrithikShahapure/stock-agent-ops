name: CI

on:
  pull_request:
    branches: [main]

permissions:
  id-token: write
  contents: read
  pull-requests: write
  security-events: write

jobs:
  # ── Security scan (mandatory gate) ─────────────────────────────────────────
  security:
    uses: ShrithikShahapure/reuseable-actions/.github/workflows/security-scan.yml@main
    with:
      enable_trivy: true
      enable_gosec: true
      go_scan_path: './internal/...'
      enable_bandit: true
      python_scan_paths: 'src/ scripts/'
      enable_npm_audit: true
      node_working_directory: 'frontend'
      fail_on_critical: true
      post_pr_comment: true

  # ── Unit tests (run after security passes) ─────────────────────────────────
  test-go:
    needs: security
    uses: ShrithikShahapure/reuseable-actions/.github/workflows/test-go.yml@main
    with:
      test_path: './internal/...'
      race: false
      coverage: false

  test-frontend:
    needs: security
    uses: ShrithikShahapure/reuseable-actions/.github/workflows/test-node.yml@main
    with:
      working_directory: 'frontend'
      test_command: 'npm test'

  # ── Terraform validate & plan (S3 backend — no TF Cloud token needed) ─────
  terraform:
    needs: [test-go, test-frontend]
    uses: ShrithikShahapure/reuseable-actions/.github/workflows/terraform-plan-s3.yml@main
    with:
      terraform_dir: 'terraform'
      aws_region: 'us-east-1'
    secrets:
      AWS_ROLE_ARN: arn:aws:iam::${{ secrets.AWS_ACCOUNT_ID }}:role/github-actions-ci-role
